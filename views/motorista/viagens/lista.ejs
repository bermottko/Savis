<div class="col-12 d-flex flex-column align-items-center mt-5">

  <form class="d-flex justify-content-center align-items-center mb-4" style="gap: 10px;" method="GET" action="">
    <input 
      type="search" 
      name="cidade" 
      value="<%= termoCidade || '' %>"
      placeholder="Pesquisar por cidade" 
      class="form-control pesquisa-custom"
      style="max-width: 250px;"
    >

    <input 
      type="date" 
      name="data" 
      value="<%= termoData || '' %>"
      class="form-control pesquisa-custom"
      style="max-width: 200px;"
    >
    <input type="hidden" name="minhas" id="campoMinhas" value="<%= minhasViagens ? '1' : '' %>">

    <button type="button" id="toggleFiltroMotorista" class="botao-cadastro pesquisa-custom" style="max-width: 200px; height: 38px;">
      <%= minhasViagens ? 'Todas as Viagens' : 'Minhas Viagens' %>
    </button>  
  </form> 

  <% if (viagens.length === 0) { %>
    <p class="text-center text-muted mt-4">Nenhuma viagem encontrada.</p>
  <% } %>

  <% viagens.forEach(function(viagem) { %>

      <!-- Cabeçalho -->
        <div class="card shadow-sm mt-2" style="width: 100%; max-width: 700px; border-radius: 10px; background-color: <%= viagem.corFundo %>;">
    <div class="card-header d-flex justify-content-between align-items-center" style="background-color: <%= viagem.corCabeca %>; border-top-left-radius:10px; border-top-right-radius:10px;">
        <span class="fw-bold" style="color: #062352; font-size: 16px">
          <%= viagem.cidadeconsul.descricao %>
        </span>
        <span class="fw-bold" style="color: #062352; font-size: 15px">
          <%= viagem.data_viagem.split('-').reverse().join('/') %>
        </span>
      </div>

      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div class="flex-grow-1">
            <img
              src="/assets/pessoa-azul.png"
              alt="Ícone de Usuário"
              class="mb-1"
              style="width: 20px; height: 20px"
            />
            <%= viagem.ocupacao %>/<%= viagem.veiculo.lugares_dispo %> Lugares Ocupados
          </div>
          <button class="botao ver-mais-btn">Ver mais</button>
        </div>

        <!-- Detalhes expansíveis -->
        <div class="detalhes">
           <div class="conteudo-principal">
          <p><strong>Horário de saída:</strong> <%= viagem.horario_saida.substring(0,5) %></p><hr />
          <p><strong>Modelo do carro:</strong> <%= viagem.veiculo.modelo_veiculo %></p><hr />
          <p><strong>Placa:</strong> <%= viagem.veiculo.placa %></p><hr />
          <p><strong>Motorista:</strong> <%= viagem.Motorista.nome %></p><hr />
          <p><strong>Status:</strong> <%= viagem.status.descricao %></p><hr />

          <% if (viagem.combustivel) { %><p><strong>Combustível:</strong> <%= viagem.combustivel %></p><hr /><% } %>
          <% if (viagem.km_inicial) { %><p><strong>Km Inicial:</strong> <%= viagem.km_inicial %></p><hr /><% } %>
          <% if (viagem.km_final) { %><p><strong>Km Final:</strong> <%= viagem.km_final %></p><hr /><% } %>
          <% if (viagem.paradas) { %><p><strong>Paradas:</strong> <%= viagem.paradas %></p><hr /><% } %>
          <% if (viagem.obs) { %><p><strong>Observações:</strong> <%= viagem.obs %></p><hr /><% } %>
          <% if (viagem.horario_chega) { %><p><strong>Horário de Chegada:</strong> <%= viagem.horario_chega.substring(0,5) %></p><hr /><% } %>

          <a href="/motorista/viagens/participantes/<%= viagem.cod %>" class="botao-visualizar">Participantes</a><br />
          <div class="d-flex justify-content-end gap-3 mt-2">
            <% if (motorista && viagem.Motorista && viagem.Motorista.cod === motorista.cod) { %>
              <a href="/motorista/viagens/relatorio/<%= viagem.cod %>" class="botao">Relatório</a>
            <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% }) %>

  <!-- PAGINAÇÃO -->
  <% if (totalPaginas > 1) { %>
    <div class="d-flex justify-content-center mt-4">
      <% if (paginaNun > 1) { %>
        <a href="?page=<%= paginaNun - 1 %>&cidade=<%= termoCidade %>&data=<%= termoData %>&minhas=<%= minhasViagens ? '1' : '' %>" class="botao-paginacao">‹</a>
      <% } else { %>
        <button class="botao-paginacao" disabled>‹</button>
      <% } %>

      <% for (let i = 1; i <= totalPaginas; i++) { %>
        <a href="?page=<%= i %>&cidade=<%= termoCidade %>&data=<%= termoData %>&minhas=<%= minhasViagens ? '1' : '' %>"
          class="botao-paginacao <%= i === paginaNun ? 'ativo' : '' %>">
          <%= i %>
        </a>
      <% } %>

      <% if (paginaNun < totalPaginas) { %>
        <a href="?page=<%= paginaNun + 1 %>&cidade=<%= termoCidade %>&data=<%= termoData %>&minhas=<%= minhasViagens ? '1' : '' %>" class="botao-paginacao">›</a>
      <% } else { %>
        <button class="botao-paginacao" disabled>›</button>
      <% } %>
    </div>
  <% } %>
</div>

<script>
  const form = document.querySelector('form');
  const inputData = form.querySelector('input[name="data"]');

  inputData.addEventListener('blur', () => {
    if (inputData.value) { 
      form.submit();
    }
  });
  // Expansão "Ver mais / Ver menos"
  document.querySelectorAll(".ver-mais-btn").forEach((btn) => {
  btn.addEventListener("click", function () {
    const detalhes = this.closest(".card").querySelector(".detalhes");
    const expandido = detalhes.classList.contains("expandido");

    if (!expandido) {
      detalhes.style.height = detalhes.scrollHeight + "px";
      detalhes.style.marginTop = "16px"; // <--- adicionar aqui
    } else {
      detalhes.style.height = "0";
      detalhes.style.marginTop = "0"; // <--- reset quando fechar
    }

    detalhes.classList.toggle("expandido");
    this.textContent = expandido ? "Ver mais" : "Ver menos";
  });
});


  // Alternar filtro "Minhas Viagens" / "Todas"
  const toggleBtn = document.getElementById("toggleFiltroMotorista");
  const campoMinhas = document.getElementById("campoMinhas");

  if (toggleBtn && campoMinhas) {
    toggleBtn.addEventListener("click", () => {
      if (campoMinhas.value === "1") {
        campoMinhas.value = "";
      } else {
        campoMinhas.value = "1";
      }
      toggleBtn.form.submit();
    });
  }

</script>


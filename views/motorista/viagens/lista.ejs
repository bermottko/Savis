<div class="col-12 d-flex flex-column align-items-center mt-5">
  <div class="d-flex justify-content-center align-items-center mb-4" style="gap: 10px;">

    <input type="search" 
          id="pesquisaCidade" 
          placeholder="Pesquisar por cidade" 
          class="form-control pesquisa-custom"
          style="max-width: 250px;">

    <input type="date" 
          id="pesquisaData" 
          class="form-control pesquisa-custom"
          style="max-width: 200px;">

    <button id="toggleFiltroMotorista" class="botao-cadastro pesquisa-custom" style="max-width: 200px; height: 38px;">
      Minhas Viagens
    </button>
  </div>
  <% viagens.forEach(function(viagem) { %>
  <div
    class="card shadow-sm mt-2<% if (typeof motorista !== 'undefined' && motorista && viagem.Motorista && viagem.Motorista.cod === motorista.cod) { %> minha<% } %>"
    data-motorista-id="<%= viagem.Motorista.cod %>"
    style="
      width: 100%;
      max-width: 700px;
      border-radius: 10px;
      background-color: #d1e3fd;
    "
  >
    <!-- Cabeçalho -->
    <div
      class="card-header d-flex justify-content-between align-items-center"
      style="
        background-color: #a7c9f9;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
      "
    >
      <span class="fw-bold" style="color: #062352; font-size: 16px">
        <%= viagem.cidadeconsul.descricao %>
      </span>
      <span
        class="fw-bold"
        style="color: #062352; font-size: 15px"
        data-date="<%= viagem.data_viagem %>"
      >
        <%= viagem.data_viagem.split('-').reverse().join('/') %>
      </span>
    </div>

    <div class="card-body">

      <div class="d-flex justify-content-between align-items-center">
        <div class="flex-grow-1">
          <img
            src="/assets/pessoa-azul.png"
            alt="Ícone de Usuário"
            class="mb-1"
            style="width: 20px; height: 20px"
          />
          <%= viagem.ocupacao %>/<%= viagem.veiculo.lugares_dispo %> Lugares Ocupados
        </div>
        <button class="botao ver-mais-btn">Ver mais</button>
      </div>

      <!-- Detalhes expansíveis -->
      <div class="detalhes">
        <p>
          <strong>Horário de saída:</strong> <%= viagem.horario_saida.substring(0,5) %>
        </p>
        <hr />
        <p>
          <strong>Modelo do carro:</strong> <%= viagem.veiculo.modelo_veiculo %>
        </p>
        <hr />
        <p><strong>Placa:</strong> <%= viagem.veiculo.placa %></p>
        <hr />
        <p><strong>Motorista:</strong> <%= viagem.Motorista.nome %></p>
        <hr />
        <p><strong>Status:</strong> <%= viagem.status.descricao %></p>
        <hr />

        <% if (viagem.combustivel) { %>
          <p><strong>Combustível:</strong> <%= viagem.combustivel %></p>
          <hr />
        <% } %>
        <% if (viagem.km_inicial) { %>
          <p><strong>Km Inicial:</strong> <%= viagem.km_inicial %></p>
          <hr />
        <% } %>
        <% if (viagem.km_final) { %>
          <p><strong>Km Final:</strong> <%= viagem.km_final %></p>
          <hr />
        <% } %>
        <% if (viagem.paradas) { %>
          <p><strong>Paradas:</strong> <%= viagem.paradas %></p>
          <hr />
        <% } %>
        <% if (viagem.obs) { %>
          <p><strong>Observações:</strong> <%= viagem.obs %></p>
          <hr />
        <% } %>
        <% if (viagem.horario_chega) { %>
          <p><strong>Horário de Chegada:</strong> <%= viagem.horario_chega.substring(0,5) %></p>
          <hr />
        <% } %>

        <a href="/motorista/viagens/participantes/<%= viagem.cod %>" class="botao-participantes">Participantes</a>
        <br />

        <div class="d-flex justify-content-end gap-3 mt-2">
          <% if (typeof motorista !== 'undefined' && motorista && viagem.Motorista && viagem.Motorista.cod === motorista.cod) { %>
            <a href="/motorista/viagens/relatorio/<%= viagem.cod %>" class="botao">Relatório</a>
          <% } %>
        </div>
      </div>
    </div>
  </div>
  <% }) %>
  <div id="paginacaoWrapper" class="d-flex justify-content-center mt-4"></div>
</div>

<script>
  // -----------------------------
  // VER MAIS / VER MENOS
  // -----------------------------
  document.querySelectorAll(".ver-mais-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      const card = this.closest(".card");
      const detalhes = card.querySelector(".detalhes");
      const estaExpandido = detalhes.classList.contains("expandido");

      if (estaExpandido) {
        detalhes.style.height = "0px";
        detalhes.style.marginTop = "0";
        detalhes.classList.remove("expandido");
        this.textContent = "Ver mais";
      } else {
        detalhes.style.height = detalhes.scrollHeight + "px";
        detalhes.style.marginTop = "16px";
        detalhes.classList.add("expandido");
        this.textContent = "Ver menos";
      }
    });
  });

  // -----------------------------
  // FILTROS + PAGINAÇÃO FRONTEND
  // -----------------------------
  const inputCidade = document.getElementById("pesquisaCidade");
  const inputData = document.getElementById("pesquisaData");
  const botaoFiltroMotorista = document.getElementById("toggleFiltroMotorista");
  const todosCards = Array.from(document.querySelectorAll(".card"));
  let filtroAtivo = false;
  let paginaAtual = 1;
  const itensPorPagina = 5;

  // Aplica os filtros
  function filtrar() {
    const termoCidade = inputCidade ? inputCidade.value.trim().toLowerCase() : "";
    const termoData = inputData ? inputData.value : "";

    todosCards.forEach((card) => {
      const cidadeText = card.querySelector(".card-header span:first-child")?.textContent.toLowerCase() || "";
      const dataAttr = card.querySelector(".card-header span:last-child")?.getAttribute("data-date") || "";

      let exibir = true;
      if (termoCidade && !cidadeText.includes(termoCidade)) exibir = false;
      if (termoData && dataAttr !== termoData) exibir = false;
      if (filtroAtivo && !card.classList.contains("minha")) exibir = false;

      card.dataset.visivel = exibir ? "true" : "false";
    });

    paginaAtual = 1; // sempre volta pra primeira página ao filtrar
    aplicarPaginacao();
  }

  // Paginação
  function aplicarPaginacao() {
    const cardsVisiveis = todosCards.filter((c) => c.dataset.visivel === "true");
    const totalPaginas = Math.max(1, Math.ceil(cardsVisiveis.length / itensPorPagina));

    // Garantir intervalo válido
    if (paginaAtual < 1) paginaAtual = 1;
    if (paginaAtual > totalPaginas) paginaAtual = totalPaginas;

    // Oculta todos
    todosCards.forEach((c) => (c.style.display = "none"));

    // Mostra apenas os da página atual
    const inicio = (paginaAtual - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    cardsVisiveis.slice(inicio, fim).forEach((c) => (c.style.display = "block"));

    renderizarPaginacao(cardsVisiveis.length, totalPaginas);
  }

  // Renderização dos botões
  function renderizarPaginacao(totalItens, totalPaginas) {
    const wrapper = document.getElementById("paginacaoWrapper");
    if (!wrapper) return;
    wrapper.innerHTML = "";

    if (totalItens === 0 || totalPaginas <= 1) return;

    const container = document.createElement("div");
    container.className = "d-flex align-items-center";
    container.style.gap = "8px";
    container.style.flexWrap = "wrap";

    // Botão anterior
    const anterior = document.createElement("button");
    anterior.className = "botao-paginacao";
    anterior.textContent = "«";
    anterior.disabled = paginaAtual === 1;
    anterior.addEventListener("click", () => {
      if (paginaAtual > 1) {
        paginaAtual--;
        aplicarPaginacao();
        scrollToTopo();
      }
    });
    container.appendChild(anterior);

    // Botões de número (simplificado, 1 a totalPaginas)
    for (let i = 1; i <= totalPaginas; i++) {
      const btn = document.createElement("button");
      btn.className = "botao-paginacao" + (i === paginaAtual ? " ativo" : "");
      btn.textContent = i;
      btn.addEventListener("click", () => {
        paginaAtual = i;
        aplicarPaginacao();
        scrollToTopo();
      });
      container.appendChild(btn);
    }

    // Botão próximo
    const proximo = document.createElement("button");
    proximo.className = "botao-paginacao";
    proximo.textContent = "»";
    proximo.disabled = paginaAtual === totalPaginas;
    proximo.addEventListener("click", () => {
      if (paginaAtual < totalPaginas) {
        paginaAtual++;
        aplicarPaginacao();
        scrollToTopo();
      }
    });
    container.appendChild(proximo);

    wrapper.appendChild(container);
  }

  function scrollToTopo() {
    document.querySelector(".col-12").scrollIntoView({ behavior: "smooth", block: "start" });
  }

  // Eventos dos filtros
  if (inputCidade) inputCidade.addEventListener("input", filtrar);
  if (inputData) inputData.addEventListener("change", filtrar);
  if (botaoFiltroMotorista) {
    botaoFiltroMotorista.addEventListener("click", () => {
      filtroAtivo = !filtroAtivo;
      botaoFiltroMotorista.textContent = filtroAtivo ? "Todas as Viagens" : "Minhas Viagens";
      filtrar();
    });
  }

  // Inicialização
  todosCards.forEach((c) => (c.dataset.visivel = "true"));
  aplicarPaginacao();
</script>
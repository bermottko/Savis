<div class="container mt-4">
  <h1 class="text-center">Lista de participantes</h1>

  <div class="row justify-content-center mb-2">
    <!-- Barra de pesquisa (centralizada) -->
    <div class="col-12 d-flex justify-content-center align-items-center mb-3" style="gap: 10px;">
      <input
        type="search"
        id="pesquisa"
        placeholder="Pesquisar usuário por nome ou CPF"
        class="form-control pesquisa-custom"
        style="max-width: 400px;"
      />
    </div>

    <!-- Aviso abaixo (fora da flex da pesquisa) -->
    <% if (viagem && viagem.veiculo && typeof ocupacao !== 'undefined' && viagem.veiculo.lugares_dispo <= ocupacao) { %>
      <div class="col-12 text-center" style="color: #9d1421;">
        Essa viagem já atingiu o limite de participantes.
      </div>
    <% } %>
  </div>

  <!-- Row que vai conter os cards - script apontará explicitamente para ela -->
  <div class="row justify-content-center mb-4 lista-participantes-row">
    <% (participantes || []).forEach(function(participante) { %>
      <div class="col-12 d-flex justify-content-center">
        <div
          class="card p-3 shadow-sm mt-2"
          style="width: 100%; max-width: 720px; background-color: #d1e3fd"
        >
          <div class="d-flex flex-row align-items-center">
            <img
              src="<%= participante.Usuario.img ? '/uploads/' + participante.Usuario.img : '/assets/default-profile.jpg' %>"
              alt="Foto de perfil"
              class="foto-perfil me-3"
            />

            <div class="flex-grow-1">
              <h5 class="nome-perfil mb-0"><%= participante.Usuario.nome %></h5>
            </div>

            <button class="botao ver-mais-btn" type="button">Ver mais</button>
          </div>

          <!--VER MAIS-->
          <div class="detalhes">
            <!-- DADOS DA VIAGEM -->
            <div class="dados-viagem">
              <p><strong>Hospital: </strong> <%= participante.local_consul %></p>
              <hr />
              <p>
                <strong>Hora: </strong> <%= participante.hora_consul.slice(0,5) %>
              </p>
              <hr />
              <p><strong>Objetivo: </strong> <%= participante.objetivo %></p>
              <hr />
              <p><strong>Observação: </strong> <%= participante.obs %></p>
              <hr />
              <p>
                <strong>Acompanhante:</strong> <% if (participante.acompanhante){%>Sim <% } else { %> Não <% } %>
              </p>
              <hr />
            <% if (participante.encaminhamento) { %>
              <a href="/uploads/<%= participante.encaminhamento %>" target="_blank" class="botao-visualizar">Encaminhamento</a>
            <% } else { %>
              <span class="text-muted" style="font-size: 13px">Não enviado</span>
            <% } %>
            <hr />
            </div>

            <!-- DADOS DO USUÁRIO (inicialmente escondidos) -->
            <div class="dados-usuario" style="display: none">
              <p>
                <strong>Data de Nascimento: </strong><%= participante.Usuario.data_nasc.split('-').reverse().join('/') %>
              </p>
              <hr />
              <p>
                <strong>CPF: </strong
                ><span class="cpf-perfil"
                  ><%= participante.Usuario.CPF.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/,"$1.$2.$3-$4") %></span
                >
              </p>
              <hr />
              <p>
                <strong>Gênero: </strong> <%= participante.Usuario.genero.descricao %>
              </p>
              <hr />
              <p><strong>Email: </strong> <%= participante.Usuario.email %></p>
              <hr />
              <p>
                <strong>Telefone: </strong><%= participante.Usuario.fone.replace(/^(\d{2})(\d{5})(\d{4})$/, "($1)$2-$3") %>
              </p>
              <hr />
              <p>
                <strong>Endereço: </strong>
                <%= participante.Usuario.endereco?.rua || '' %>,
                <%=participante.Usuario.endereco?.numero || '' %> -
                <%=participante.Usuario.endereco?.bairro || '' %> -
                <%= participante.Usuario.endereco?.cidade || '' %>
                (<%=participante.Usuario.endereco?.UF || '' %>)
                CEP: <%= participante.Usuario.endereco?.CEP ? participante.Usuario.endereco.CEP.replace(/^(\d{5})(\d{3})$/,"$1-$2") : '' %>
              </p>
              <hr />
              <p><strong>SUS: </strong> <%= participante.Usuario.SUS %></p>
              <hr />

              <% if (participante.acompanhante) { %>
                <div class="d-flex flex-row align-items-center">
                  <img
                    src="<%= participante.acompanhante.img ? '/uploads/' + participante.acompanhante.img : '/assets/default-profile.jpg' %>"
                    alt="Foto de perfil"
                    class="foto-perfil me-3"
                  />

                  <div class="flex-grow-1">
                    <h5 class="nome-perfil mb-0">
                      <%= participante.acompanhante.nome %>
                    </h5>
                    <p>(Acompanhante)</p>
                  </div>
                </div>
                <br />
                <p>
                  <strong>Data de Nascimento: </strong><%= participante.acompanhante.data_nasc.split('-').reverse().join('/') %>
                </p>
                <hr />
                <p><strong>CPF: </strong> <%= participante.acompanhante.cpf %></p>
                <hr />
                <p>
                  <strong>Gênero: </strong> <%= participante.acompanhante.genero.descricao %>
                </p>
                <hr />
                <p>
                  <strong>Telefone: </strong><%= participante.acompanhante.telefone.replace(/^(\d{2})(\d{5})(\d{4})$/,"($1) $2-$3") %>
                </p>
                <hr />
              <% } %>
            </div>

            <div class="d-flex justify-content-end gap-3 mt-2">
            <a class="botao botao-visualizar-dados" style="cursor: pointer">Dados do Usuário</a>
           <form action="/admin/viagens/desvincular/<%= participante.cod %>?_method=DELETE" method="POST">
          </form>
          </div>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</div>

<script>
  const inputPesquisa = document.getElementById("pesquisa");
  const cards = Array.from(document.querySelectorAll(".card"));
  // Seleciona explicitamente a row que contém os cards
  const row = document.querySelector(".lista-participantes-row");

  cards.forEach((card, index) => {
    card.setAttribute("data-original-index", index);
  });

  inputPesquisa.addEventListener("input", function () {
    const termo = this.value.trim().toLowerCase();

    if (termo.length === 0) {
      cards.forEach((card) => {
        card.style.display = "block";
        card.setAttribute("data-relevancia", "0");
      });

      const fragment = document.createDocumentFragment();

      cards
        .sort(
          (a, b) =>
            a.getAttribute("data-original-index") - a.getAttribute("data-original-index") + (0) // mantém ordem original
        )
        .forEach((card) => fragment.appendChild(card));

      row.appendChild(fragment);
    } else {
      cards.forEach((card) => {
        const nomeELemento = card.querySelector(".nome-perfil");
        const nome = nomeELemento ? nomeELemento.textContent.toLowerCase() : "";

        const cpfElemento = card.querySelector(".cpf-perfil");
        const cpf = cpfElemento ? cpfElemento.textContent.replace(/[.\-]/g, "") : "";

        if (nome.startsWith(termo) || cpf.startsWith(termo)) {
          card.style.display = "block";
          card.setAttribute("data-relevancia", "1");
        } else if (nome.includes(termo) || cpf.includes(termo)) {
          card.style.display = "block";
          card.setAttribute("data-relevancia", "2");
        } else {
          card.style.display = "none";
          card.setAttribute("data-relevancia", "99");
        }
      });

      const fragment = document.createDocumentFragment();

      cards
        .filter((card) => card.style.display === "block")
        .sort(
          (a, b) =>
            a.getAttribute("data-relevancia") - b.getAttribute("data-relevancia")
        )
        .forEach((card) => fragment.appendChild(card));

      row.appendChild(fragment);
    }
  });

  // VER MAIS / VER MENOS
  document.querySelectorAll(".ver-mais-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      const card = this.closest(".card");
      const detalhes = card.querySelector(".detalhes");
      const estaExpandido = detalhes.classList.contains("expandido");

      if (estaExpandido) {
        detalhes.style.height = "0px";
        detalhes.style.marginTop = "0";
        detalhes.classList.remove("expandido");
        this.textContent = "Ver mais";
      } else {
        detalhes.style.height = detalhes.scrollHeight + "px";
        detalhes.style.marginTop = "16px";
        detalhes.classList.add("expandido");
        this.textContent = "Ver menos";
      }
    });
  });

  document.querySelectorAll(".botao-visualizar-dados").forEach((botao) => {
    botao.addEventListener("click", function () {
      const card = this.closest(".card");
      const dadosUsuario = card.querySelector(".dados-usuario");
      const dadosViagem = card.querySelector(".dados-viagem");
      const detalhes = card.querySelector(".detalhes");

      const mostrandoUsuario = dadosUsuario.style.display === "block";

      if (mostrandoUsuario) {
        dadosUsuario.style.display = "none";
        dadosViagem.style.display = "block";
        this.textContent = "Dados do Usuário";
      } else {
        dadosUsuario.style.display = "block";
        dadosViagem.style.display = "none";
        this.textContent = "Dados da Viagem";
      }

      if (detalhes.classList.contains("expandido")) {
        detalhes.style.height = "auto";
        const novaAltura = detalhes.scrollHeight;
        detalhes.style.height = novaAltura + "px";
      }
    });
  });
</script>

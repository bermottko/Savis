<form
    id="formParticipante"
    action="<%= action %>"
    method="POST"
    class="container mt-4"
    enctype="multipart/form-data"
    novalidate
    data-ocupacao="<%= ocupacao %>"
    data-lugares="<%= viagem.veiculo.lugares_dispo %>"
  >

      <h2 class="mb-4 titulo">Formulário do Participante</h2>

      <input type="hidden" name="usuarioID" value="<%= usuario.cod %>" /> 
      <input type="hidden" name="viagemID" value="<%= viagem.cod %>" />
      <input type="hidden" name="cidadeconsulID" value="<%= viagem.cidadeconsulID %>" />
      <input type="hidden" name="data_consul" value="<%= viagem.data_viagem %>" />

      <div class="mb-3">
        <label class="form-label">Hospital</label>
        <input
          type="text"
          id="local_consul"
          name="local_consul"
          class="form-control"
          maxlength="100"
          placeholder="Digite o Hospital da Consulta"
        />
        <div class="text-danger small" id="erroLocal"></div>
      </div>

      <div class="mb-3">
        <label class="form-label">Horário da Consulta</label>
        <input
          type="time"
          id="hora_consul"
          name="hora_consul"
          class="form-control"
        />
        <div class="text-danger small" id="erroHora"></div>
      </div>

      <div class="mb-3">
        <label class="form-label">Encaminhamento</label>
        <input
          type="file"
          id="encaminhamento"
          name="encaminhamento"
          accept="application/pdf"
          class="form-control"
        />
        <div class="text-danger small" id="erroEncaminhamento"></div>
      </div>

      <div class="mb-3">
        <label class="form-label">Objetivo da Consulta</label>
        <input
          type="text"
          id="objetivo"
          name="objetivo"
          class="form-control"
          maxlength="60"
          placeholder="Digite o objetivo da consulta"
        />
        <div class="text-danger small" id="erroObjetivo"></div>
      </div>

      <div class="mb-3">
        <label class="form-label">Observação</label>
        <input
          type="text"
          name="obs"
          class="form-control"
          maxlength="255"
          placeholder="Adicione uma observação caso necessário"
        />
      </div>

      <div class="mb-3">
        <label class="form-label me-2">Acompanhante</label>
        <input
          type="radio"
          id="temAcompSim"
          name="temAcompanhante"
          value="sim"
          onclick="toggleCamposAcomp()"
        />
        Sim
        <input
          type="radio"
          id="temAcompNao"
          name="temAcompanhante"
          value="nao"
          checked
          onclick="toggleCamposAcomp()"
        />
        Não
      </div>

      <!-- Campos do acompanhante -->
      <div id="camposAcompanhante" style="display: none">
        <div class="text-center">
          <label for="foto_acompanhante">
            <img
              id="preview_foto_acompanhante"
              src="/assets/default-profile.jpg"
              alt="Foto do acompanhante"
              class="rounded-circle mt-3 mb-2"
              style="
                width: 90px;
                height: 90px;
                object-fit: cover;
                cursor: pointer;
                border: 2px solid #ccc;
              "
            />
          </label>
          <input
            type="file"
            id="foto_acompanhante"
            name="foto_acompanhante"
            accept="image/*"
            class="d-none"
            onchange="previewImagemAcompanhante(event)"
          />
        </div>

        <div class="mb-3">
          <label class="form-label">Nome</label>
          <input
            type="text"
            id="nome_acomp"
            name="nome_acomp"
            class="form-control"
            maxlength="100"
            placeholder="Digite o nome completo do acompanhante"
          />
          <div class="text-danger small" id="erroNomeAcomp"></div>
        </div>

        <div class="mb-3">
          <label class="form-label">CPF</label>
          <input
            type="text"
            id="cpf_acomp"
            name="cpf_acomp"
            class="form-control"
            maxlength="14"
            placeholder="Digite o CPF do acompanhante"
          />
          <div class="text-danger small" id="erroCpfAcomp"></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Data de Nascimento</label>
          <input
            type="date"
            id="data_nasc_acomp"
            name="data_nasc_acomp"
            class="form-control"
          />
          <div class="text-danger small" id="erroDataNascAcomp"></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Telefone</label>
          <input
            type="text"
            id="telefone_acomp"
            name="telefone_acomp"
            class="form-control"
            maxlength="15"
            placeholder="Digite o número do acompanhante"
          />
          <div class="text-danger small" id="erroTelefoneAcomp"></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Gênero</label>
          <select name="generoID" id="generoID" class="form-control">
            <option value="" disabled selected>Selecione</option>
            <option value="1">Masculino</option>
            <option value="2">Feminino</option>
            <option value="3">Não-Binário</option>
            <option value="4">Outro</option>
          </select>
          <div class="text-danger small" id="erroGeneroAcomp"></div>
        </div>
      </div>

      <div class="mb-3 d-flex justify-content-end">
        <button type="submit" class="botao">
          <%= modo === 'usuario' ? 'Submeter' : 'Vincular' %>
        </button>
      </div>
    </form>

    </div>
</div>

<script>
  function previewImagemAcompanhante(event) {
    const input = event.target;
    const img = document.getElementById("preview_foto_acompanhante");
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        img.src = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function toggleCamposAcomp() {
    const form = document.getElementById("formParticipante");
    const sim = document.getElementById("temAcompSim").checked;
    const campos = document.getElementById("camposAcompanhante");

    const ocupacao = parseInt(form.dataset.ocupacao);
    const lugares = parseInt(form.dataset.lugares);

    if (sim) {
      if (ocupacao >= lugares - 1) {
        alert("Esta viagem não comporta mais um acompanhante.");
        document.getElementById("temAcompNao").checked = true;
        campos.style.display = "none";
      } else {
        campos.style.display = "block";
      }
    } else {
      campos.style.display = "none";
    }
  }

  function validarFormulario(e) {
    e.preventDefault();
    let erros = false,
      primeiroErro = null;

    // Limpa mensagens de erro
    [
      "erroLocal",
      "erroHora",
      "erroEncaminhamento",
      "erroObjetivo",
      "erroNomeAcomp",
      "erroCpfAcomp",
      "erroDataNascAcomp",
      "erroTelefoneAcomp",
      "erroGeneroAcomp",
    ].forEach((id) => (document.getElementById(id).innerText = ""));

    const local = document.getElementById("local_consul");
    const hora = document.getElementById("hora_consul");
    const objetivo = document.getElementById("objetivo");
    const encaminhamento = document.getElementById("encaminhamento");
    const form = document.getElementById("formParticipante");
    const ocupacao = parseInt(form.dataset.ocupacao);
    const lugares = parseInt(form.dataset.lugares);

    if (!local.value.trim()) {
      document.getElementById("erroLocal").innerText = "Informe o hospital.";
      erros = true;
      primeiroErro = primeiroErro || local;
    }
    if (!hora.value) {
      document.getElementById("erroHora").innerText = "Informe o horário.";
      erros = true;
      primeiroErro = primeiroErro || hora;
    }
    if (!objetivo.value.trim()) {
      document.getElementById("erroObjetivo").innerText = "Informe o objetivo.";
      erros = true;
      primeiroErro = primeiroErro || objetivo;
    }
    if (!encaminhamento.value) {
      document.getElementById("erroEncaminhamento").innerText =
        "Envie o encaminhamento em PDF.";
      erros = true;
      primeiroErro = primeiroErro || encaminhamento;
    }

    // Validação do acompanhante
    if (document.getElementById("temAcompSim").checked) {
      if (ocupacao >= lugares - 1) {
        alert("Esta viagem não comporta mais um acompanhante.");
        erros = true;
      }

      const nome = document.getElementById("nome_acomp");
      const cpf = document.getElementById("cpf_acomp");
      const dataNasc = document.getElementById("data_nasc_acomp");
      const telefone = document.getElementById("telefone_acomp");
      const genero = document.getElementById("generoID");

      if (!nome.value.trim()) {
        document.getElementById("erroNomeAcomp").innerText = "Digite o nome.";
        erros = true;
        primeiroErro = primeiroErro || nome;
      }
      if (cpf.value.replace(/\D/g, "").length !== 11) {
        document.getElementById("erroCpfAcomp").innerText = "CPF inválido.";
        erros = true;
        primeiroErro = primeiroErro || cpf;
      }
      if (!dataNasc.value) {
        document.getElementById("erroDataNascAcomp").innerText =
          "Informe a data.";
        erros = true;
        primeiroErro = primeiroErro || dataNasc;
      }
      if (telefone.value.replace(/\D/g, "").length < 10) {
        document.getElementById("erroTelefoneAcomp").innerText =
          "Telefone inválido.";
        erros = true;
        primeiroErro = primeiroErro || telefone;
      }
      if (!genero.value) {
        document.getElementById("erroGeneroAcomp").innerText =
          "Selecione o gênero.";
        erros = true;
        primeiroErro = primeiroErro || genero;
      }
    }

    if (erros) primeiroErro && primeiroErro.focus();
    else e.target.submit();
  }

  document
    .getElementById("formParticipante")
    .addEventListener("submit", validarFormulario);

  // Máscaras
  document.getElementById("cpf_acomp").addEventListener("input", (e) => {
    let v = e.target.value.replace(/\D/g, "");
    v = v.replace(/^(\d{3})(\d)/, "$1.$2");
    v = v.replace(/^(\d{3})\.(\d{3})(\d)/, "$1.$2.$3");
    v = v.replace(/\.(\d{3})(\d)/, ".$1-$2");
    e.target.value = v;
  });

  document.getElementById("telefone_acomp").addEventListener("input", (e) => {
    let v = e.target.value.replace(/\D/g, "");
    if (v.length > 10) v = v.replace(/^(\d{2})(\d{5})(\d{4})$/, "($1) $2-$3");
    else v = v.replace(/^(\d{2})(\d{4})(\d{4})$/, "($1) $2-$3");
    e.target.value = v;
  });
</script>

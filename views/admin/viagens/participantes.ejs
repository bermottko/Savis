<div class="container mt-4">
  <h1>Lista de participantes</h1>

  <div class="d-flex justify-content-center align-items-center mb-3" style="gap: 10px">
    <% if (viagem.veiculo?.lugares_dispo > ocupacao) { %>
      <form action="/admin/viagens/adicionar-participante/<%= viagem.cod %>" method="get">
        <button type="submit" class="botao-cadastro">Adicionar Participante</button>
      </form>
    <% } %>
  </div>

  <% if (viagem.veiculo?.lugares_dispo <= ocupacao) { %>
    <div class="text-center" style="color: #9d1421;"> 
      Essa viagem atingiu o limite de participantes.
    </div>
  <% } %>

  <% if (participantes && participantes.length > 0) { %>
    <% participantes.forEach(participante => { %>
      <!-- Card do participante -->
      <div class="col-12 d-flex justify-content-center">
        <div class="card p-3 shadow-sm mt-2" style="width: 100%; max-width: 720px; background-color: #d1e3fd">
          <div class="d-flex flex-row align-items-center">
            <img src="<%= participante.Usuario.img ? '/uploads/' + participante.Usuario.img : '/assets/default-profile.jpg' %>"
                 alt="Foto de perfil" class="foto-perfil me-3" />
            <div class="flex-grow-1">
              <h5 class="nome-perfil mb-0"><%= participante.Usuario.nome %></h5>
            </div>
            <button class="botao ver-mais-btn" type="button">Ver mais</button>
          </div>

          <div class="detalhes">
            <div class="dados-viagem">
              <p><strong>Hospital: </strong> <%= participante.local_consul %></p>
              <hr />
              <p><strong>Hora: </strong> <%= participante.hora_consul.slice(0,5) %></p>
              <hr />
              <p><strong>Objetivo: </strong> <%= participante.objetivo %></p>
              <% if (participante.obs) { %>
                <hr />
                <p><strong>Observação: </strong> <%= participante.obs %></p>
              <% } %>
              <hr />
              <% if (participante.encaminhamento) { %>
                <a href="/uploads/<%= participante.encaminhamento %>" target="_blank" class="botao-visualizar">Encaminhamento</a>
              <% } else { %>
                <span class="text-muted" style="font-size: 13px">Não enviado</span>
              <% } %>
              <hr />
            </div>

            <div class="dados-usuario" style="display: none">
              <p><strong>Data de Nascimento: </strong><%= participante.Usuario.data_nasc.split('-').reverse().join('/') %></p>
              <hr />
              <p><strong>CPF: </strong><%= participante.Usuario.CPF %></p>
              <hr />
              <p><strong>Gênero: </strong> <%= participante.Usuario.genero.descricao %></p>
              <hr />
              <% if (participante.Usuario.email) { %>
                <p><strong>Email: </strong> <%= participante.Usuario.email %></p>
                <hr />
              <% } %>
              <p><strong>Telefone: </strong> <%= participante.Usuario.fone %></p>
              <hr />
              <p><strong>Endereço: </strong>
                <%= participante.Usuario.endereco?.rua || '' %>,
                <%= participante.Usuario.endereco?.numero || '' %> - 
                <%= participante.Usuario.endereco?.bairro || '' %> - 
                <%= participante.Usuario.endereco?.cidade || '' %> 
                (<%= participante.Usuario.endereco?.UF || '' %>)
                CEP: <%= participante.Usuario.endereco?.CEP || '' %>
              </p>
              <hr />
              <p><strong>SUS: </strong> <%= participante.Usuario.SUS %></p>
              <hr />
            </div>

            <div class="d-flex justify-content-end gap-3 mt-2">
              <a class="botao botao-visualizar-dados" style="cursor: pointer">Dados do Usuário</a>
              <form action="/admin/viagens/desvincular/<%= participante.cod %>?_method=DELETE" method="POST">
                <button type="submit" class="botao bg-vermelho">Desvincular</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <% if (participante.acompanhante) { %>
        <!-- Card do acompanhante -->
        <div class="col-12 d-flex justify-content-center">
          <div class="card p-3 shadow-sm mt-2" style="width: 100%; max-width: 720px; background-color: #f0f0f0">
            <div class="d-flex flex-row align-items-center">
              <img src="<%= participante.acompanhante.img ? '/uploads/' + participante.acompanhante.img : '/assets/default-profile.jpg' %>"
                   alt="Foto de perfil" class="foto-perfil me-3" />
              <div class="flex-grow-1">
                <h5 class="nome-perfil mb-0"><%= participante.acompanhante.nome %></h5>
              </div>
              <button class="botao ver-mais-btn" type="button">Ver mais</button>
            </div>

            <div class="detalhes">
              <div class="dados-usuario">
                <p>Acompanhante de <%= participante.Usuario.nome %></p>
                <hr>
                <p><strong>Data de Nascimento: </strong><%= participante.acompanhante.data_nasc.split('-').reverse().join('/') %></p>
                <hr>
                <p><strong>CPF: </strong><%= participante.acompanhante.cpf %></p>
                <hr>
                <p><strong>Gênero: </strong><%= participante.acompanhante.genero.descricao %></p>
                <hr>
                <p><strong>Telefone: </strong><%= participante.acompanhante.telefone %></p>
                <hr>
              </div>
            </div>
          </div>
        </div>
      <% } %>

    <% }) %>

  <% } else { %>
    <p class="text-center mt-4">Não há nenhum participante vinculado a essa viagem.</p>
  <% } %>
</div>

<script>
  // Ver mais / Ver menos
  document.querySelectorAll(".ver-mais-btn").forEach(btn => {
    btn.addEventListener("click", function() {
      const card = this.closest(".card");
      const detalhes = card.querySelector(".detalhes");
      const estaExpandido = detalhes.classList.contains("expandido");
      if (estaExpandido) {
        detalhes.style.height = "0px";
        detalhes.style.marginTop = "0";
        detalhes.classList.remove("expandido");
        this.textContent = "Ver mais";
      } else {
        detalhes.style.height = detalhes.scrollHeight + "px";
        detalhes.style.marginTop = "16px";
        detalhes.classList.add("expandido");
        this.textContent = "Ver menos";
      }
    });
  });

  // Alterna dados do usuário / dados da viagem
  document.querySelectorAll(".botao-visualizar-dados").forEach(botao => {
    botao.addEventListener("click", function() {
      const card = this.closest(".card");
      const dadosUsuario = card.querySelector(".dados-usuario");
      const dadosViagem = card.querySelector(".dados-viagem");
      const detalhes = card.querySelector(".detalhes");
      const mostrandoUsuario = dadosUsuario?.style.display === "block";
      if (mostrandoUsuario) {
        dadosUsuario.style.display = "none";
        if (dadosViagem) dadosViagem.style.display = "block";
        this.textContent = "Dados do Usuário";
      } else {
        if (dadosUsuario) dadosUsuario.style.display = "block";
        if (dadosViagem) dadosViagem.style.display = "none";
        this.textContent = "Dados da Viagem";
      }
      if (detalhes.classList.contains("expandido")) {
        detalhes.style.height = detalhes.scrollHeight + "px";
      }
    });
  });
</script>

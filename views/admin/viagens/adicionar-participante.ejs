<div class="container mt-4">
  <h1>Selecione um usuário para vincular à viagem</h1>

  <div class="d-flex justify-content-center align-items-center mb-4" style="gap: 10px;">
    <form action="/admin/viagens/adicionar-participante/<%= cod %>" method="GET" class="d-flex align-items-center" style="gap: 10px;">
    <input
      type="search"
      name="q"
      value="<%= termoPesquisa %>"
      placeholder="Pesquisar usuário por nome ou CPF"
      class="form-control pesquisa-custom"
    />
  </form>

    <button id="btnVincular" class="botao-cadastro" disabled>Vincular</button>
  </div>

  <div class="row justify-content-center mb-5" id="row-usuarios">
    <% posts.forEach(function(post) { %>
      <div class="col-12 d-flex justify-content-center">
        <div class="card card-viagem card-selecao p-3 shadow-sm mt-2" 
          data-cod="<%= post.cod %>" 
          >
          <div class="d-flex flex-row align-items-center">

            <img src="<%= post.img ? '/uploads/' + post.img : '/assets/default-profile.jpg' %>" 
                 alt="Foto de perfil" 
                 class="foto-perfil me-3">

            <div class="flex-grow-1">
              <h5 class="nome-perfil mb-0"><%= post.nome %></h5>
            </div>

            <button class="botao ver-mais-btn" type="button">Ver mais</button>
          </div>

          <!-- DETALHES EXPANDÍVEIS -->
          <div class="detalhes">
            <p><strong>Data de Nascimento: </strong><%= post.data_nasc.split('-').reverse().join('/') %></p>
            <hr>
            <p><strong>CPF: </strong><span class="cpf-perfil"><%= post.CPF.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, "$1.$2.$3-$4") %></span></p>
            <hr>
            <p><strong>Gênero: </strong> <%= post.genero.descricao %></p>
            <hr>
            <p><strong>Email: </strong> <%= post.email %></p>
            <hr>
            <p><strong>Telefone: </strong><%= post.fone.replace(/^(\d{2})(\d{5})(\d{4})$/, "($1) $2-$3") %></p>
            <hr>
            <p><strong>Endereço: </strong>
              <%= post.endereco?.rua || '' %>, 
              <%= post.endereco?.numero || '' %> - 
              <%= post.endereco?.bairro || '' %> - 
              <%= post.endereco?.cidade || '' %> 
              (<%= post.endereco?.UF || '' %>) 
              CEP: <%= post.endereco?.CEP ? post.endereco.CEP.replace(/^(\d{5})(\d{3})$/, "$1-$2") : '' %>
            </p>
            <hr>
            <p><strong>SUS: </strong> <%= post.SUS %></p>
            <hr>
          </div>
        </div>
      </div>
    <% }) %>
  
    <% if (posts.length === 0) { %>
      <p class="text-center text-muted mt-4">Nenhum usuário encontrado.</p>
    <% } else { %>
  
      <div class="d-flex justify-content-between align-items-center mt-4" style="max-width: 700px; margin: 0 auto;">
  
  <!-- BOTÃO VOLTAR -->
  <a href="#" onclick="window.history.back(); return false;" class="botao">
    Voltar
  </a>

  <!-- PAGINAÇÃO -->
  <div class="d-flex justify-content-center align-items-center" style="flex-grow: 1; gap: 6px;">
    <% if (paginaNun > 1) { %>
      <a href="?page=<%= paginaNun - 1 %>&q=<%= termoPesquisa %>" class="botao-paginacao">‹</a>
    <% } else { %>
      <button class="botao-paginacao" disabled>‹</button>
    <% } %>

    <% for (let i = 1; i <= totalPaginas; i++) { %>
      <a href="?page=<%= i %>&q=<%= termoPesquisa %>" class="botao-paginacao <%= i === paginaNun ? 'ativo' : '' %>">
        <%= i %>
      </a>
    <% } %>

    <% if (paginaNun < totalPaginas) { %>
      <a href="?page=<%= paginaNun + 1 %>&q=<%= termoPesquisa %>" class="botao-paginacao">›</a>
    <% } else { %>
      <button class="botao-paginacao" disabled>›</button>
    <% } %>
  </div>

  <!-- Espaço vazio à direita para equilibrar -->
  <div style="width: 70px;"></div>

</div>



    <% } %>
  </div>
</div>
<script>

const cards = Array.from(document.querySelectorAll('.card-selecao'));
const btnVincular = document.getElementById('btnVincular');

let usuarioSelecionado = null;

// Ver mais / ver menos
document.querySelectorAll('.ver-mais-btn').forEach(btn => {
  btn.addEventListener('click', function (e) {
    e.stopPropagation(); // evita que o clique no card dispare a seleção
    const card = this.closest('.card-selecao');
    const detalhes = card.querySelector('.detalhes');
    const expandido = detalhes.classList.contains('expandido');

    if (expandido) {
      detalhes.style.height = '0px';
      detalhes.style.marginTop = '0';
      detalhes.classList.remove('expandido');
      this.textContent = 'Ver mais';
    } else {
      detalhes.style.height = detalhes.scrollHeight + 'px';
      detalhes.style.marginTop = '16px';
      detalhes.classList.add('expandido');
      this.textContent = 'Ver menos';
    }
  });
});

// Seleção de card
cards.forEach(card => {
  card.addEventListener('click', function () {
    // Remove seleção dos outros cards
    cards.forEach(c => c.classList.remove('selecionado'));

    // Marca este card como selecionado
    this.classList.add('selecionado');

    // Guarda o código do usuário
    usuarioSelecionado = this.getAttribute('data-cod');

    // Ativa botão Vincular
    btnVincular.disabled = false;
  });
});

// Vincular
btnVincular.addEventListener('click', () => {
  if (!usuarioSelecionado) return;
  const codViagem = "<%= cod %>";
  window.location.href = `/admin/viagens/formulario-participante/${codViagem}?usuarioSelecionado=${usuarioSelecionado}`;
});
</script>
